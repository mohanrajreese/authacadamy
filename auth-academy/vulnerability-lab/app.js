// Vulnerability Lab - Interactive Security Demos

function init() {
    // Lab 1: None Algorithm Attack
    document.getElementById('executeAttack').addEventListener('click', executeNoneAttack);

    // Lab 2: Secret Cracking
    populatePasswordList();
    document.getElementById('startCrack').addEventListener('click', startCracking);

    console.log('ðŸ”“ Vulnerability Lab loaded');
}

// Lab 1: None Algorithm Attack Demo
function executeNoneAttack() {
    const newRole = document.getElementById('newRole').value;

    // Create "none" algorithm header
    const header = { alg: "none", typ: "JWT" };
    const payload = { sub: "1234567890", name: "John Doe", role: newRole };

    // Encode without signature
    const encodedHeader = btoa(JSON.stringify(header)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
    const encodedPayload = btoa(JSON.stringify(payload)).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');

    // Forged token with empty signature
    const forgedToken = `${encodedHeader}.${encodedPayload}.`;

    // Display result
    document.getElementById('forgedToken').textContent = forgedToken;
    document.getElementById('forgedRole').textContent = `role: "${newRole}"`;
    document.getElementById('attackResult').classList.remove('hidden');

    // Visual feedback
    showToast('âš ï¸ Attack executed! Token forged with "none" algorithm');
}

// Lab 2: Secret Cracking Demo
const commonPasswords = [
    'password', '123456', 'secret', 'password123', 'admin',
    'qwerty', 'letmein', '12345678', 'secret123', 'changeme',
    'welcome', 'passw0rd', 'test', 'guest', 'master'
];

const targetSecret = 'secret123'; // The "secret" to crack

function populatePasswordList() {
    const container = document.getElementById('passwordAttempts');
    container.innerHTML = commonPasswords.map(pwd =>
        `<div class="password-item" data-password="${pwd}">${pwd}</div>`
    ).join('');
}

async function startCracking() {
    const items = document.querySelectorAll('.password-item');
    const startTime = Date.now();

    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        item.classList.add('trying');

        await sleep(150); // Simulate cracking time

        if (item.dataset.password === targetSecret) {
            item.classList.remove('trying');
            item.classList.add('found');

            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(1);

            document.getElementById('crackedSecret').textContent = targetSecret;
            document.getElementById('crackTime').textContent = duration;
            document.getElementById('crackResult').classList.remove('hidden');

            showToast('ðŸ”“ Secret cracked! Never use weak passwords.');
            return;
        }

        item.classList.remove('trying');
    }
}

// Utilities
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function showToast(message) {
    // Create toast if not exists
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast';
        toast.innerHTML = '<span id="toastMessage"></span>';
        document.body.appendChild(toast);

        // Add styles
        toast.style.cssText = `
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background: #12121a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            z-index: 1000;
            color: white;
        `;
    }

    toast.querySelector('#toastMessage').textContent = message;
    toast.style.display = 'block';

    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

// Initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
